<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SQL Playground</title>
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; --ok:#16a34a; --warn:#dc2626; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:#111; }
    header { padding: 16px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:18px; }
    #status { color: var(--muted); font-size:14px; }
    main { display:grid; grid-template-columns: 360px 1fr; gap: 16px; padding:16px; }
    @media (max-width: 900px) { main { grid-template-columns: 1fr; } }
    .panel { border:1px solid var(--border); border-radius:12px; background:#fff; min-height:200px; }
    .panel .pad { padding:16px; }
    .panel h2 { margin:0 0 8px; font-size:16px; }
    .muted { color: var(--muted); }
    select, button { padding:8px 12px; border-radius:10px; border:1px solid #cfcfcf; background:#fff; }
    button.primary { background:#111; color:#fff; border-color:#111; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    /* Editor */
    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:8px; }
    #results { margin-top:12px; border:1px solid var(--border); border-radius:10px; padding:10px; min-height:52px; overflow:auto; }
    table { border-collapse:collapse; width:100%; }
    th,td { border:1px solid var(--border); padding:6px 8px; text-align:left; }
    th { background:#f9fafb; position:sticky; top:0; }
    td.col-idx, th.col-idx { width:56px; text-align:right; color:#6b7280; background:#fafafa; position:sticky; left:0; }
    tr:nth-child(even) td { background:#fcfcfc; }
    /* CodeMirror */
    .CodeMirror { border:1px solid var(--border); border-radius:10px; height:260px; }
  </style>

  <!-- CodeMirror -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/neo.min.css">
</head>
<body>
  <header>
    <h1>SQL Playground</h1>
    <div id="status" class="muted">Loading…</div>
  </header>

  <main>
    <!-- LEFT: challenge selector -->
    <section class="panel">
      <div class="pad">
        <h2>Workspace</h2>
        <label class="muted" for="challenge">Challenge</label><br/>
        <select id="challenge" style="margin-top:6px; width:100%"></select>
        <p id="challenge-desc" class="muted" style="margin-top:8px;">
          Select a challenge to load its dataset and starter SQL.
        </p>
      </div>
    </section>

    <!-- RIGHT: editor + run/results -->
    <section class="panel">
      <div class="pad">
        <h2>Editor</h2>
        <textarea id="editor">-- Select a challenge from the left to load starter SQL</textarea>

        <div class="toolbar">
          <button id="run" class="primary" disabled title="Ctrl/Cmd + Enter">Run</button>
          <button id="reset" disabled>Reset DB</button>
          <span id="run-info" class="muted"></span>
        </div>

        <div id="results" class="muted">Run a query to see results here.</div>
      </div>
    </section>
  </main>

  <!-- sql.js + CodeMirror -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>

  <script>
    let SQL, db, cm = null;

    const els = {
      status: document.getElementById('status'),
      challengeSelect: document.getElementById('challenge'),
      challengeDesc: document.getElementById('challenge-desc'),
      editorTA: document.getElementById('editor'),
      run: document.getElementById('run'),
      reset: document.getElementById('reset'),
      runInfo: document.getElementById('run-info'),
      results: document.getElementById('results')
    };

    // App state
    const APP = {
      challenges: [],
      current: null,         // {id,title,seed,starter,solution,expect_columns}
      seedSQL: '',
      starterSQL: '',
      solutionSQL: '',
      expectColumns: []
    };

    function setReady(on) {
      els.run.disabled = !on;
      els.reset.disabled = !on;
      els.status.textContent = on ? 'Ready' : 'Loading…';
      els.status.className = on ? 'muted' : 'muted';
    }

    function getSQL() { return cm ? cm.getValue() : els.editorTA.value; }
    function setSQL(s) { if (cm) cm.setValue(s); else els.editorTA.value = s; }

    function render(result) {
      if (!result || !result.columns) {
        els.results.innerHTML = '<span class="muted">No rows.</span>'; return;
      }
      const { columns, values } = result;
      let html = '<table><thead><tr>';
      html += '<th class="col-idx">#</th>';
      html += columns.map(c=>`<th>${c}</th>`).join('');
      html += '</tr></thead><tbody>';
      for (let i=0;i<values.length;i++) {
        const row = values[i];
        html += '<tr>';
        html += `<td class="col-idx">${i+1}</td>`;
        html += row.map(v=>`<td>${v===null?'<i>null</i>':String(v)}</td>`).join('');
        html += '</tr>';
      }
      html += '</tbody></table>';
      els.results.innerHTML = html;
      els.results.classList.remove('muted');
    }

    async function boot() {
      try {
        setReady(false);

        // Editor (CodeMirror)
        if (window.CodeMirror) {
          cm = CodeMirror.fromTextArea(els.editorTA, {
            mode: 'text/x-sql',
            theme: 'neo',
            lineNumbers: true,
            autofocus: true
          });
          cm.addKeyMap({ 'Ctrl-Enter': runQuery, 'Cmd-Enter': runQuery });
        }

        // SQL engine
        SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });

        // Load challenges index
        const idxResp = await fetch('challenges/challenges.json');
        if (!idxResp.ok) throw new Error('Cannot load challenges.json (' + idxResp.status + ')');
        APP.challenges = await idxResp.json();
        if (!Array.isArray(APP.challenges) || !APP.challenges.length) {
          els.status.textContent = 'No challenges found.'; els.status.className='warn'; return;
        }

        // Populate dropdown
        els.challengeSelect.innerHTML = APP.challenges.map(c => `<option value="${c.id}">${c.title}</option>`).join('');
        els.challengeSelect.addEventListener('change', () => loadChallenge(els.challengeSelect.value));

        // Auto-load first challenge
        await loadChallenge(APP.challenges[0].id);
        setReady(true);
      } catch (e) {
        els.status.textContent = 'Failed to initialize: ' + e.message;
        els.status.className = 'warn';
      }
    }

    async function loadChallenge(id) {
      try {
        setReady(false);
        const meta = APP.challenges.find(c => c.id === id);
        if (!meta) throw new Error('Challenge not found: ' + id);
        APP.current = meta;

        // Fetch seed & starter (& solution for later grading)
        const [seedText, starterText, solutionText] = await Promise.all([
          fetch(meta.seed).then(r => { if(!r.ok) throw new Error('Seed not found'); return r.text(); }),
          fetch(meta.starter).then(r => { if(!r.ok) throw new Error('Starter not found'); return r.text(); }),
          fetch(meta.solution).then(r => { if(!r.ok) throw new Error('Solution not found'); return r.text(); })
        ]);

        APP.seedSQL = seedText;
        APP.starterSQL = starterText;
        APP.solutionSQL = solutionText;
        APP.expectColumns = Array.isArray(meta.expect_columns) ? meta.expect_columns : [];

        // Reset DB with this seed
        db = new SQL.Database();
        db.run(APP.seedSQL);

        // Put starter SQL in editor
        setSQL(APP.starterSQL);

        // Quick preview of first table (if any)
        const tnames = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name");
        if (tnames.length && tnames[0].values.length) {
          const firstTable = tnames[0].values[0][0];
          const res = db.exec(`SELECT * FROM ${firstTable} LIMIT 5`);
          if (res.length) render(res[0]);
        } else {
          els.results.innerHTML = '<span class="muted">Seed loaded (no tables).</span>';
        }

        els.challengeDesc.textContent = meta.title;
      } catch (e) {
        els.status.textContent = 'Load error: ' + e.message;
        els.status.className = 'warn';
      } finally {
        setReady(true);
      }
    }

    function runQuery() {
      if (!db) { els.results.innerHTML = '<span class="warn">DB not ready.</span>'; return; }
      const sql = getSQL().trim();
      els.runInfo.textContent = 'Running…';
      const t0 = performance.now();
      try {
        const results = db.exec(sql);
        const ms = Math.max(1, Math.round(performance.now() - t0));
        if (!results.length) {
          els.results.innerHTML = '<span class="muted">Query OK (no rows)</span>';
          els.runInfo.textContent = `Time: ${ms} ms`;
        } else {
          render(results[0]);
          const rows = results[0].values.length;
          els.runInfo.textContent = `Rows: ${rows} • Time: ${ms} ms`;
        }
      } catch (e) {
        els.results.innerHTML = '<span class="warn">' + e.message + '</span>';
        els.runInfo.textContent = '';
      }
    }

    function resetDB() {
      if (!APP.seedSQL) return;
      db = new SQL.Database();
      db.run(APP.seedSQL);
      els.runInfo.textContent = 'DB reset';
      const tnames = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name");
      if (tnames.length && tnames[0].values.length) {
        const firstTable = tnames[0].values[0][0];
        const res = db.exec(`SELECT * FROM ${firstTable} LIMIT 5`);
        if (res.length) render(res[0]);
      } else {
        els.results.innerHTML = '<span class="muted">Seed loaded (no tables).</span>';
      }
    }

    // Events
    document.getElementById('run').addEventListener('click', runQuery);
    document.getElementById('reset').addEventListener('click', resetDB);
    document.addEventListener('keydown', (e) => {
      if (cm) {
        // CodeMirror handles keymaps we added; no-op here
      } else if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        runQuery(); // textarea fallback
      }
    });

    // Start
    boot();
  </script>
</body>
</html>
