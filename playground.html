<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SQL Playground</title>
  <style>
    :root{
      --border:#e5e7eb; --muted:#6b7280;
      --ok:#16a34a; --ok-d:#15803d;
      --warn:#dc2626; --bg:#f3f4f6;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; color:#111
    }
    header{
      padding:12px 20px; border-bottom:1px solid var(--border);
      background:#fff; display:flex; justify-content:space-between; align-items:center; gap:12px
    }
    header h1{ margin:0; font-size:18px }
    #status{ display:none } /* Keep for JS but hidden */

    .hstack{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .pickerbar{
      background:#fff; border-bottom:1px solid var(--border);
      padding:10px 20px; display:flex; align-items:center; gap:16px; flex-wrap:wrap
    }
    .help{ color:#374151; font-size:13px }

    main{
      max-width:1400px; margin:0 auto;
      display:grid; grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:16px; padding:16px
    }
    @media (max-width: 900px){ main{ grid-template-columns:1fr } }

    .panel{ border:1px solid var(--border); border-radius:12px; background:#fff; min-width:0; }
    .panel .pad{ padding:16px }
    .panel h2{ margin:0 0 8px; font-size:16px }
    .muted{ color: var(--muted) }
    .ok{ color:var(--ok); font-weight:600 }
    .warn{ color:var(--warn); font-weight:600 }

    select,button{
      padding:8px 12px; border-radius:10px; border:1px solid #cfcfcf; background:#fff
    }
    button.primary{ background:#111; color:#fff; border-color:#111; cursor:pointer }
    button.success{ background:var(--ok); color:#fff; border-color:var(--ok); cursor:pointer }
    button.success:hover{ background:var(--ok-d); border-color:var(--ok-d) }
    button:disabled{ opacity:.5; cursor:not-allowed }
    button.success:disabled{ background:#e5e7eb; border-color:#e5e7eb; color:#9ca3af }

    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:8px }

    .CodeMirror{
      border:1px solid var(--border); border-radius:10px;
      height:clamp(220px, 45vh, 520px); background:#fff; width:100%;
    }
    textarea{ width:100%; min-height:220px; }

    #results{
      margin-top:12px; border:1px solid var(--border); border-radius:10px;
      padding:10px; min-height:52px; max-height:clamp(160px, 38vh, 460px);
      overflow:auto; background:#fff;
    }
    #grade-diff{ margin-top:10px; overflow:auto }
    .table-wrap{ width:100%; overflow:auto }
    table{ border-collapse:collapse; width:100%; min-width:600px; }
    th,td{ border:1px solid var(--border); padding:6px 8px; text-align:left; vertical-align:top; overflow-wrap:anywhere }
    th{ background:#f9fafb; position:sticky; top:0; }
    td.col-idx, th.col-idx{ width:56px; text-align:right; color:#6b7280; background:#fafafa; position:sticky; left:0 }
    tr:nth-child(even) td{ background:#fcfcfc }
    @media (max-width: 700px){
      th{ position:static }
      td.col-idx, th.col-idx{ position:static }
      table{ min-width:480px }
    }

    pre.ascii{
      background:#f9fafb; border:1px solid var(--border); border-radius:10px;
      padding:10px; overflow:auto; margin:8px 0; font-size:13px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      line-height:1.35;
    }

    /* Markdown description styles */
    .markdown :is(h1,h2,h3){ margin:10px 0 6px; font-weight:700 }
    .markdown h1{ font-size:18px }
    .markdown h2{ font-size:16px }
    .markdown h3{ font-size:15px }
    .markdown p{ margin:8px 0 }
    .markdown ul{ margin:6px 0 6px 22px }
    .markdown li{ margin:4px 0 }
    .markdown code{ background:#f3f4f6; border:1px solid var(--border); border-radius:6px; padding:0 4px }
    .markdown pre code{ display:block; padding:10px; border-radius:10px }

    /* Hidden until a challenge & (SQLite) grader is ready */
    .when-ready{ display:none; }
    .subhelp{ color: var(--muted); font-size:12px; margin-top:2px; }
  </style>

  <!-- CodeMirror -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/neo.min.css">
</head>
<body>
<header>
  <div>
    <h1>SQL Playground</h1>
    <div class="subhelp">Select one of the real-world style challenges to start.</div>
    <div id="status" class="muted"></div>
  </div>
</header>

  <!-- Picker -->
<div class="pickerbar">
  <div class="hstack">
    <label for="challenge" class="muted" style="font-size:13px;">Challenge</label>
    <select id="challenge"></select>
  </div>
  <div class="hstack">
    <label for="editor-mode" class="muted" style="font-size:13px;">Language</label>
    <select id="editor-mode">
      <option value="sql">SQL (SQLite engine)</option>
      <option value="mysql">MySQL (syntax only)</option>
    </select>
  </div>
</div>

  <main>
    <!-- LEFT -->
    <section class="panel">
      <div class="pad">
        <h2 id="challenge-title">Workspace</h2>
        <div id="question" class="markdown muted">
          <p>Select a challenge to see the details and schema.</p>
        </div>

        <h3 style="margin-top:12px;">Schema</h3>
        <div id="schema" class="muted">—</div>

        <h3 style="margin-top:12px;">Validate your result</h3>
        <div class="muted" style="font-size:14px;">
          Choose the task your query answers, then click <b>Check</b>. We’ll compare your result with the expected answer. (Appears after you load a challenge.)
        </div>

        <div class="hstack" style="margin-top:6px">
          <select id="which-check" class="when-ready" disabled>
            <option value="1A">Part 1 — Audit</option>
            <option value="2">Part 2 — Flags table</option>
            <option value="3">Part 3 — Roll-up (final)</option>
          </select>
          <button id="mini-check" class="when-ready" disabled>Check</button>
          <span id="mini-status" class="muted when-ready"></span>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel">
      <div class="pad">
        <h2>Editor</h2>
        <textarea id="editor">-- Pick a challenge to start your query here.</textarea>

        <div class="toolbar">
          <button id="run" class="primary" disabled title="Ctrl/Cmd + Enter">Run</button>
          <span class="muted" style="font-size:12px;">Ctrl/⌘+Enter</span>
          <button id="reset" disabled>Reset DB</button>
          <button id="check" class="success" disabled>Submit (Grade)</button>
          <span id="run-info" class="muted"></span>
          <span id="grade-status" class="muted"></span>
          <span id="dialect-note" class="muted" style="font-size:12px;"></span>
        </div>

        <div id="results" class="muted">Test results will show here.</div>
        <div id="grade-diff"></div>
      </div>
    </section>
  </main>

  <!-- Engines & libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

  <script>
    // ----- Helpers / state -----
    const bust = (u) => u + (u.includes('?') ? '&' : '?') + 'v=' + Date.now();

    // Blank starter (keeps answers out of the editor)
    const DEFAULT_STARTER = `-- You can run any SELECTs you need to explore
-- e.g.
-- SELECT * FROM some_table LIMIT 5;

-- Write your solution below:
`;

    let SQL, db, cm = null;
    const APP = {
      challenges: [],
      current: null,
      seedSQL: '',
      starterSQL: '',
      graderReady: false,
      grader: null
    };

    // ----- Elements -----
    const els = {
      status: document.getElementById('status'),
      challengeSelect: document.getElementById('challenge'),
      modeSelect: document.getElementById('editor-mode'),
      challengeTitle: document.getElementById('challenge-title'),
      question: document.getElementById('question'),
      schema: document.getElementById('schema'),
      editorTA: document.getElementById('editor'),
      run: document.getElementById('run'),
      reset: document.getElementById('reset'),
      check: document.getElementById('check'),
      runInfo: document.getElementById('run-info'),
      gradeStatus: document.getElementById('grade-status'),
      gradeDiff: document.getElementById('grade-diff'),
      results: document.getElementById('results'),
      whichCheck: document.getElementById('which-check'),
      miniCheckBtn: document.getElementById('mini-check'),
      miniStatus: document.getElementById('mini-status'),
      dialectNote: document.getElementById('dialect-note')
    };

    // ----- UI helpers -----
    function sqliteModeOn(){ return !els.modeSelect || els.modeSelect.value === 'sql'; }
    function updateDialectNote(){
      els.dialectNote.textContent = sqliteModeOn() ? '' : 'Checks run on SQLite. MySQL mode changes highlighting only.';
    }
    function toggleCheckRow(canShow){
      document.querySelectorAll('.when-ready').forEach(el => el.style.display = (canShow ? '' : 'none'));
    }
    function setControlsEnabled(on){
      els.run.disabled = !on;
      els.reset.disabled = !on;

      const sqliteOnly = sqliteModeOn();
      const canCheck = on && APP.graderReady && sqliteOnly;
      els.check.disabled = !canCheck;
      els.miniCheckBtn.disabled = !canCheck;
      els.whichCheck.disabled = !canCheck;
      toggleCheckRow(canCheck);

      if (on && APP.graderReady && !sqliteOnly){
        els.miniStatus.textContent = 'Checks are SQLite-only. Switch Language to SQL to enable.';
        els.miniStatus.className = 'muted';
      } else {
        els.miniStatus.textContent = '';
      }
      updateDialectNote();
    }
    function getSQL(){ return cm ? cm.getValue() : els.editorTA.value; }
    function setSQL(s){ if (cm) cm.setValue(s); else els.editorTA.value = s; }

    // ----- Rendering -----
    function tableHTML(result){
      if (!result || !result.columns) return '<span class="muted">No rows.</span>';
      const { columns, values } = result;
      let html = '<div class="table-wrap"><table><thead><tr>';
      html += '<th class="col-idx">#</th>';
      html += columns.map(c=>`<th>${c}</th>`).join('');
      html += '</tr></thead><tbody>';
      for (let i=0;i<values.length;i++){
        html += '<tr>';
        html += `<td class="col-idx">${i+1}</td>`;
        html += values[i].map(v=>`<td>${v===null?'<i>null</i>':String(v)}</td>`).join('');
        html += '</tr>';
      }
      html += '</tbody></table></div>';
      return html;
    }
    function renderTable(result){
      els.results.innerHTML = tableHTML(result);
      els.results.classList.remove('muted');
    }
    function renderSchema(){
      if (!db){ els.schema.textContent = '—'; return; }
      try{
        const res = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name");
        const tables = res.length ? res[0].values.map(r => r[0]) : [];
        if (!tables.length){ els.schema.innerHTML = '<em>No tables found.</em>'; return; }

        const pad = (s,n)=>String(s)+' '.repeat(Math.max(0,n-String(s).length));
        const asciiTable = (cols)=>{
          const nameW = Math.max('Column Name'.length, ...cols.map(c=>String(c.name).length));
          const typeW = Math.max('Type'.length, ...cols.map(c=>String(c.type||'').length));
          const line  = '+' + '-'.repeat(nameW+2) + '+' + '-'.repeat(typeW+2) + '+';
          let out = line+'\n' + `| ${pad('Column Name',nameW)} | ${pad('Type',typeW)} |\n` + line+'\n';
          for (const c of cols) out += `| ${pad(c.name,nameW)} | ${pad(c.type||'',typeW)} |\n`;
          out += line; return out;
        };

        let html = '';
        for (const t of tables){
          const colsRes = db.exec(`PRAGMA table_info(${t})`);
          const cols = (colsRes.length ? colsRes[0].values : []).map(r=>({ name:r[1], type:r[2]||'', pk:r[5]?Number(r[5]):0 }));
          const pkCols = cols.filter(c=>c.pk>0).sort((a,b)=>a.pk-b.pk).map(c=>c.name);
          html += `<div class="schema-block">`;
          html += `<div class="schema-title" style="font-weight:600; margin-bottom:6px">Table: <span style="background:#eef2f7;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;">${t}</span></div>`;
          html += `<pre class="ascii">${asciiTable(cols)}</pre>`;
          if (pkCols.length===1) html += `<div class="muted"><code>${pkCols[0]}</code> is the primary key.</div>`;
          else if (pkCols.length>1) html += `<div class="muted">Composite PK: <code>${pkCols.join(', ')}</code>.</div>`;
          else html += `<div class="muted">No declared primary key.</div>`;
          html += `</div>`;
        }
        els.schema.innerHTML = html;
      }catch(e){ els.schema.innerHTML = '<span class="warn">Error loading schema: '+e.message+'</span>'; }
    }

    // ----- Boot -----
    async function boot(){
      try{
        // Editor
        if (window.CodeMirror){
          cm = CodeMirror.fromTextArea(els.editorTA, { mode:'text/x-sql', theme:'neo', lineNumbers:true, autofocus:true });
          cm.addKeyMap({ 'Ctrl-Enter': runQuery, 'Cmd-Enter': runQuery });
        }

        // SQL engine
        SQL = await initSqlJs({ locateFile:f=>`https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });

        // Load challenge index with cache-bust
        const idxResp = await fetch(bust('challenges/challenges.json'));
        if (!idxResp.ok) throw new Error('Cannot load challenges.json ('+idxResp.status+')');
        APP.challenges = await idxResp.json();

        if (!Array.isArray(APP.challenges) || !APP.challenges.length){
          els.results.innerHTML = '<span class="warn">No challenges found. Ensure <code>challenges/challenges.json</code> exists.</span>';
        }

        // Sort by "order" if present; label as "Challenge N: Title"
        APP.challenges.sort((a,b)=> (a.order ?? 1e9) - (b.order ?? 1e9));
        const opts = ['<option value="">— Select a challenge —</option>']
          .concat(APP.challenges.map(c=>{
            const label = (c.order ? `Challenge ${c.order}: ${c.title}` : c.title);
            return `<option value="${c.id}">${label}</option>`;
          }));
        els.challengeSelect.innerHTML = opts.join('');

        // Handlers
        els.challengeSelect.addEventListener('change', onChallengeChange);
        els.modeSelect.addEventListener('change', onDialectChange);

        setControlsEnabled(false);
        updateDialectNote();
      }catch(e){
        els.results.innerHTML = '<span class="warn">Initialize error: '+e.message+'</span>';
      }
    }

    function onDialectChange(){
      if (!cm) return;
      const v = els.modeSelect.value;
      cm.setOption('mode', v === 'mysql' ? 'text/x-mysql' : 'text/x-sql');
      setControlsEnabled(!!db);
    }

    function resetToNeutral(){
      APP.current = null; APP.seedSQL = APP.starterSQL = '';
      APP.grader = null; APP.graderReady = false; db = null;
      setControlsEnabled(false);
      els.challengeTitle.textContent = 'Workspace';
      els.question.innerHTML = '<p>Details and schema of the challenge will show here.</p>';
      setSQL('-- Pick a challenge to start your query here.');
      els.schema.textContent = '—';
      els.results.textContent = 'Test results will show here.';
      els.gradeDiff.innerHTML = ''; els.gradeStatus.textContent = ''; els.runInfo.textContent = '';
      els.miniStatus.textContent = '';
    }

    async function onChallengeChange(){
      const val = els.challengeSelect.value;
      if (!val) { resetToNeutral(); return; }
      await loadChallenge(val);
    }

    // ----- Challenge load -----
    async function loadChallenge(id){
      try{
        setControlsEnabled(false);

        const meta = APP.challenges.find(c=>c.id===id);
        if (!meta) throw new Error('Challenge not found: ' + id);
        APP.current = meta;

        // Seed & starter (cache-busted)
        const [seedText, starterText] = await Promise.all([
          fetch(bust(meta.seed)).then(r=>{ if(!r.ok) throw new Error('Seed not found'); return r.text(); }),
          fetch(bust(meta.starter)).then(r=>{ if(!r.ok) throw new Error('Starter not found'); return r.text(); })
        ]);
        APP.seedSQL = seedText; APP.starterSQL = starterText;

        // Reset DB
        db = new SQL.Database();
        db.run(APP.seedSQL);

        // Description (Markdown or HTML), cache-busted
        let desc = meta.description || '';
        if (meta.description_file){
          try{
            const d = await fetch(bust(meta.description_file));
            if (d.ok) desc = await d.text();
          }catch(_){}
        }
        const label = (meta.order ? `Challenge ${meta.order}: ${meta.title}` : (meta.title || 'Workspace'));
        els.challengeTitle.textContent = label;

        // Render markdown safely
        const html = DOMPurify.sanitize(marked.parse(desc || 'No description provided.'));
        els.question.innerHTML = html;

        // Always show a clean starter (no answers)
        setSQL(DEFAULT_STARTER);

        // Schema + quick preview
        renderSchema();
        const tnames = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name");
        if (tnames.length && tnames[0].values.length){
          const firstTable = tnames[0].values[0][0];
          const res = db.exec(`SELECT * FROM ${firstTable} LIMIT 5`);
          if (res.length) renderTable(res[0]); else els.results.innerHTML = '<span class="muted">Seed loaded.</span>';
        } else {
          els.results.innerHTML = '<span class="muted">Seed loaded (no tables).</span>';
        }

        // Optional grader
        APP.graderReady = false; APP.grader = null;
        if (meta.grader){ await loadGrader(meta.grader); }

        setControlsEnabled(true);
      }catch(e){
        els.results.innerHTML = '<span class="warn">Load error: '+e.message+'</span>';
      }
    }

    async function loadGrader(src){
      const old = document.querySelector('script[data-challenge-grader]');
      if (old) old.remove();

      APP.grader = null; window.CHALLENGE_GRADER = null;

      await new Promise((resolve) => {
        const s = document.createElement('script');
        s.src = src + (src.includes('?') ? '&' : '?') + 'v=' + Date.now();
        s.async = true;
        s.dataset.challengeGrader = '1';
        s.onload = () => {
          if (window.CHALLENGE_GRADER) { APP.grader = window.CHALLENGE_GRADER; APP.graderReady = true; }
          resolve();
        };
        s.onerror = () => resolve();
        document.body.appendChild(s);
      });
    }

    // ----- Actions -----
    function runQuery(){
      if (!db){ els.results.innerHTML = '<span class="muted">No challenge loaded.</span>'; return; }
      const sql = getSQL().trim();
      els.runInfo.textContent = 'Running…';
      const t0 = performance.now();
      try{
        const results = db.exec(sql);
        const ms = Math.max(1, Math.round(performance.now()-t0));
        if (!results.length){
          els.results.innerHTML = '<span class="muted">Query OK (no rows)</span>';
          els.runInfo.textContent = `Time: ${ms} ms`;
        } else {
          renderTable(results[0]);
          els.runInfo.textContent = `Rows: ${results[0].values.length} • Time: ${ms} ms`;
        }
      }catch(e){
        els.results.innerHTML = '<span class="warn">'+e.message+'</span>';
        els.runInfo.textContent = '';
      }
    }

    function resetDB(){
      if (!APP.seedSQL){ els.results.innerHTML = '<span class="muted">No challenge loaded.</span>'; return; }
      db = new SQL.Database(); db.run(APP.seedSQL); els.runInfo.textContent = 'DB reset';
      renderSchema();
      const tnames = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name");
      if (tnames.length && tnames[0].values.length){
        const firstTable = tnames[0].values[0][0];
        const res = db.exec(`SELECT * FROM ${firstTable} LIMIT 5`);
        if (res.length) renderTable(res[0]); else els.results.innerHTML = '<span class="muted">Seed loaded.</span>';
      } else { els.results.innerHTML = '<span class="muted">Seed loaded (no tables).</span>'; }
    }

    async function miniCheck(){
      if (!APP.graderReady || !APP.grader){ els.miniStatus.textContent = 'Checks unavailable for this challenge.'; return; }
      if (!sqliteModeOn()){
        els.miniStatus.textContent='Checks run on SQLite. Switch Language to "SQL (SQLite engine)" to validate.';
        els.miniStatus.className='warn'; return;
      }
      try{
        els.miniStatus.textContent = 'Checking…'; els.miniStatus.className = 'muted';
        els.gradeDiff.innerHTML = ''; els.gradeStatus.textContent = '';

        const partId = els.whichCheck.value;
        const userSQL = getSQL().trim();
        if (!/^select/i.test(userSQL)){
          els.miniStatus.textContent='Write a SELECT query to check.'; els.miniStatus.className='warn'; return;
        }

        const r = await APP.grader.check(partId, userSQL, APP.seedSQL, SQL);
        if (r && r.ok){
          els.miniStatus.textContent = r.status || '✅ Passed!';
          els.miniStatus.className = 'ok';
          els.gradeDiff.innerHTML = r.diffHTML || '';
        } else {
          els.miniStatus.textContent = (r && r.status) ? r.status : '❌ Not correct.';
          els.miniStatus.className = 'warn';
          els.gradeDiff.innerHTML = (r && r.diffHTML) ? r.diffHTML : '';
        }
      }catch(e){
        els.miniStatus.textContent = 'Error: ' + e.message; els.miniStatus.className = 'warn';
      }
    }

    async function grade(){
      if (!APP.graderReady || !APP.grader){
        els.gradeStatus.textContent = 'Checks unavailable for this challenge.'; els.gradeStatus.className='warn'; return;
      }
      if (!sqliteModeOn()){
        els.gradeStatus.textContent='Checks run on SQLite. Switch Language to "SQL (SQLite engine)" to validate.';
        els.gradeStatus.className='warn'; return;
      }
      try{
        els.gradeStatus.textContent = 'Grading…'; els.gradeStatus.className = 'muted'; els.gradeDiff.innerHTML = '';
        const userSQL = getSQL().trim();
        if (!/^select/i.test(userSQL)){
          els.gradeStatus.textContent='Only SELECT queries can be submitted.'; els.gradeStatus.className='warn'; return;
        }

        const r = await APP.grader.grade(userSQL, APP.seedSQL, SQL);
        if (r && r.ok){
          els.gradeStatus.textContent = r.status || '✅ Correct!';
          els.gradeStatus.className = 'ok';
          els.gradeDiff.innerHTML = r.diffHTML || '';
        } else {
          els.gradeStatus.textContent = (r && r.status) ? r.status : '❌ Not quite — see differences below.';
          els.gradeStatus.className = 'warn';
          els.gradeDiff.innerHTML = (r && r.diffHTML) ? r.diffHTML : '';
        }
      }catch(e){
        els.gradeStatus.textContent = 'Error: ' + e.message; els.gradeStatus.className = 'warn';
      }
    }

    // ----- Wire up & start -----
    document.getElementById('run').addEventListener('click', runQuery);
    document.getElementById('reset').addEventListener('click', resetDB);
    document.getElementById('mini-check').addEventListener('click', miniCheck);
    document.getElementById('check').addEventListener('click', grade);
    document.addEventListener('keydown', (e)=>{ if (!cm && (e.ctrlKey||e.metaKey) && e.key==='Enter') runQuery(); });

    boot();
  </script>
</body>
</html>
