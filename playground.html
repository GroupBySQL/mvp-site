<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SQL Playground</title>
  <style>
    :root{
      --border:#e5e7eb; --muted:#6b7280;
      --ok:#16a34a; --ok-d:#15803d;
      --warn:#dc2626; --bg:#f3f4f6; /* light gray page bg */
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; color:#111
    }
    header{
      padding:16px 20px; border-bottom:1px solid var(--border);
      background:#fff; display:flex; justify-content:space-between; align-items:center
    }
    header h1{ margin:0; font-size:18px }
    #status{ color:var(--muted); font-size:14px }

    /* 50/50 layout, responsive */
    main{
      max-width:1400px; margin:0 auto;
      display:grid; grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:16px; padding:16px
    }
    @media (max-width: 900px){
      main{ grid-template-columns:1fr }
    }

    .panel{ border:1px solid var(--border); border-radius:12px; background:#fff; min-width:0; }
    .panel .pad{ padding:16px }
    .panel h2{ margin:0 0 8px; font-size:16px }
    .muted{ color:var(--muted) }

    select,button{
      padding:8px 12px; border-radius:10px; border:1px solid #cfcfcf; background:#fff
    }
    button.primary{ background:#111; color:#fff; border-color:#111; cursor:pointer }
    button.success{ background:var(--ok); color:#fff; border-color:var(--ok); cursor:pointer }
    button.success:hover{ background:var(--ok-d); border-color:var(--ok-d) }
    button:disabled{ opacity:.5; cursor:not-allowed }

    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:8px }

    /* Editor */
    .CodeMirror{
      border:1px solid var(--border); border-radius:10px;
      height:clamp(220px, 45vh, 520px); background:#fff; width:100%;
    }
    textarea{ width:100%; min-height:220px; }

    /* Results / tables */
    #results{
      margin-top:12px; border:1px solid var(--border); border-radius:10px;
      padding:10px; min-height:52px; max-height:clamp(160px, 38vh, 460px);
      overflow:auto; background:#fff;
    }
    #grade-diff{ margin-top:10px; overflow:auto }
    .table-wrap{ width:100%; overflow:auto } /* horizontal scroll on small screens */
    table{ border-collapse:collapse; width:100%; min-width:600px; }
    th,td{ border:1px solid var(--border); padding:6px 8px; text-align:left; vertical-align:top; overflow-wrap:anywhere }
    th{ background:#f9fafb; position:sticky; top:0; }
    td.col-idx, th.col-idx{ width:56px; text-align:right; color:#6b7280; background:#fafafa; position:sticky; left:0 }
    tr:nth-child(even) td{ background:#fcfcfc }
    /* On narrow screens, disable sticky to prevent clipping */
    @media (max-width: 700px){
      th{ position:static }
      td.col-idx, th.col-idx{ position:static }
      table{ min-width:480px }
    }

    /* Schema (LeetCode-style) */
    #schema .schema-block{ margin-top:12px }
    #schema .schema-title{ font-weight:600; margin-bottom:6px }
    #schema .schema-title .tag{
      display:inline-block; padding:2px 8px; border-radius:999px;
      font-size:12px; background:#eef2f7; border:1px solid #e5e7eb;
    }
    pre.ascii{
      background:#f9fafb; border:1px solid var(--border); border-radius:10px;
      padding:10px; overflow:auto; margin:8px 0; font-size:13px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      line-height:1.35;
    }
    #question{ white-space:pre-wrap; margin-top:8px }
    #schema code{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace }
    @media (max-width:600px){ .panel .pad{ padding:12px } }
  </style>

  <!-- CodeMirror -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/neo.min.css">
</head>
<body>
  <header>
    <h1>SQL Playground</h1>
    <div id="status" class="muted">Loading…</div>
  </header>

  <main>
    <!-- LEFT: challenge selector + question + schema -->
    <section class="panel">
      <div class="pad">
        <h2>Workspace</h2>
        <label class="muted" for="challenge">Challenge</label><br/>
        <select id="challenge" style="margin-top:6px; width:100%"></select>

        <h3 id="challenge-title" style="margin-top:12px;"></h3>
        <div id="question" class="muted">Select a challenge to load its instructions.</div>

        <h3 style="margin-top:12px;">Schema</h3>
        <div id="schema" class="muted">Loading schema…</div>
      </div>
    </section>

    <!-- RIGHT: editor + run/results -->
    <section class="panel">
      <div class="pad">
        <h2>Editor</h2>
        <textarea id="editor">-- Select a challenge from the left to load starter SQL</textarea>

        <div class="toolbar">
          <button id="run" class="primary" disabled title="Ctrl/Cmd + Enter">Run</button>
          <button id="reset" disabled>Reset DB</button>
          <button id="check" class="success" disabled>Submit (Grade)</button>
          <span id="run-info" class="muted"></span>
          <span id="grade-status" class="muted"></span>
        </div>

        <div id="results" class="muted">Run a query to see results here.</div>
        <div id="grade-diff"></div>
      </div>
    </section>
  </main>

  <!-- sql.js + CodeMirror -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>

  <script>
    let SQL, db, cm = null;

    const els = {
      status: document.getElementById('status'),
      challengeSelect: document.getElementById('challenge'),
      challengeTitle: document.getElementById('challenge-title'),
      question: document.getElementById('question'),
      schema: document.getElementById('schema'),
      editorTA: document.getElementById('editor'),
      run: document.getElementById('run'),
      reset: document.getElementById('reset'),
      check: document.getElementById('check'),
      runInfo: document.getElementById('run-info'),
      gradeStatus: document.getElementById('grade-status'),
      gradeDiff: document.getElementById('grade-diff'),
      results: document.getElementById('results')
    };

    // App state
    const APP = {
      challenges: [],
      current: null,         // {id,title,description,description_file,seed,starter,solution,expect_columns}
      seedSQL: '',
      starterSQL: '',
      solutionSQL: '',
      expectColumns: []
    };

    function setReady(on) {
      els.run.disabled = !on;
      els.reset.disabled = !on;
      els.check.disabled = !on;
      els.status.textContent = on ? 'Ready' : 'Loading…';
      els.status.className = on ? 'muted' : 'muted';
    }

    function getSQL() { return cm ? cm.getValue() : els.editorTA.value; }
    function setSQL(s) { if (cm) cm.setValue(s); else els.editorTA.value = s; }

    function tableHTML(result){
      const { columns, values } = result;
      let html = '<div class="table-wrap"><table><thead><tr>';
      html += '<th class="col-idx">#</th>';
      html += columns.map(c=>`<th>${c}</th>`).join('');
      html += '</tr></thead><tbody>';
      for (let i=0;i<values.length;i++) {
        const row = values[i];
        html += '<tr>';
        html += `<td class="col-idx">${i+1}</td>`;
        html += row.map(v=>`<td>${v===null?'<i>null</i>':String(v)}</td>`).join('');
        html += '</tr>';
      }
      html += '</tbody></table></div>';
      return html;
    }

    function renderTable(result) {
      if (!result || !result.columns) {
        els.results.innerHTML = '<span class="muted">No rows.</span>'; return;
      }
      els.results.innerHTML = tableHTML(result);
      els.results.classList.remove('muted');
    }

    // ----- LeetCode-style Schema Renderer -----
    function renderSchema() {
      try {
        const res = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name");
        const tables = res.length ? res[0].values.map(r => r[0]) : [];
        if (!tables.length) { els.schema.innerHTML = '<em>No tables found.</em>'; return; }

        // helpers
        const pad = (s, n) => String(s) + ' '.repeat(Math.max(0, n - String(s).length));
        const asciiTable = (cols) => {
          const nameW = Math.max('Column Name'.length, ...cols.map(c => String(c.name).length));
          const typeW = Math.max('Type'.length, ...cols.map(c => String(c.type || '').length));
          const line  = '+' + '-'.repeat(nameW+2) + '+' + '-'.repeat(typeW+2) + '+';
          let out = '';
          out += line + '\n';
          out += `| ${pad('Column Name', nameW)} | ${pad('Type', typeW)} |\n`;
          out += line + '\n';
          for (const c of cols) out += `| ${pad(c.name, nameW)} | ${pad(c.type || '', typeW)} |\n`;
          out += line;
          return out;
        };

        let html = '';
        for (const t of tables) {
          const colsRes = db.exec(`PRAGMA table_info(${t})`);
          const cols = (colsRes.length ? colsRes[0].values : []).map(r => ({
            name: r[1], type: r[2] || '', pk: r[5] ? Number(r[5]) : 0
          }));
          const pkCols = cols.filter(c => c.pk > 0).sort((a,b)=>a.pk-b.pk).map(c => c.name);

          html += `<div class="schema-block">`;
          html += `<div class="schema-title">Table: <span class="tag">${t}</span></div>`;
          html += `<pre class="ascii">${asciiTable(cols)}</pre>`;

          if (pkCols.length === 1) {
            html += `<div class="muted"><code>${pkCols[0]}</code> is the primary key (column with unique values) for this table.</div>`;
          } else if (pkCols.length > 1) {
            html += `<div class="muted">(<code>${pkCols.join(', ')}</code>) is the primary key (combination of columns with unique values) for this table.</div>`;
          } else {
            html += `<div class="muted">This table does not declare a primary key.</div>`;
          }

          html += `</div>`;
        }
        els.schema.innerHTML = html;
      } catch (e) {
        els.schema.innerHTML = '<span class="warn">Error loading schema: ' + e.message + '</span>';
      }
    }
    // ------------------------------------------

    async function boot() {
      try {
        setReady(false);

        // Editor (CodeMirror)
        if (window.CodeMirror) {
          cm = CodeMirror.fromTextArea(els.editorTA, {
            mode: 'text/x-sql',
            theme: 'neo',
            lineNumbers: true,
            autofocus: true
          });
          cm.addKeyMap({ 'Ctrl-Enter': runQuery, 'Cmd-Enter': runQuery });
        }

        // SQL engine
        SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });

        // Load challenges index
        const idxResp = await fetch('challenges/challenges.json');
        if (!idxResp.ok) throw new Error('Cannot load challenges.json (' + idxResp.status + ')');
        APP.challenges = await idxResp.json();
        if (!Array.isArray(APP.challenges) || !APP.challenges.length) {
          els.status.textContent = 'No challenges found.'; els.status.className='warn'; return;
        }

        // Populate dropdown
        els.challengeSelect.innerHTML = APP.challenges.map(c => `<option value="${c.id}">${c.title}</option>`).join('');
        els.challengeSelect.addEventListener('change', () => loadChallenge(els.challengeSelect.value));

        // Auto-load first challenge
        await loadChallenge(APP.challenges[0].id);
        setReady(true);
      } catch (e) {
        els.status.textContent = 'Failed to initialize: ' + e.message;
        els.status.className = 'warn';
      }
    }

    async function loadChallenge(id) {
      try {
        setReady(false);
        const meta = APP.challenges.find(c => c.id === id);
        if (!meta) throw new Error('Challenge not found: ' + id);
        APP.current = meta;

        const [seedText, starterText, solutionText] = await Promise.all([
          fetch(meta.seed).then(r => { if(!r.ok) throw new Error('Seed not found'); return r.text(); }),
          fetch(meta.starter).then(r => { if(!r.ok) throw new Error('Starter not found'); return r.text(); }),
          fetch(meta.solution).then(r => { if(!r.ok) throw new Error('Solution not found'); return r.text(); })
        ]);

        APP.seedSQL = seedText;
        APP.starterSQL = starterText;
        APP.solutionSQL = solutionText;
        APP.expectColumns = Array.isArray(meta.expect_columns) ? meta.expect_columns : [];

        // Reset DB with this seed
        db = new SQL.Database();
        db.run(APP.seedSQL);

        // Load description: prefer file if provided, else inline text
        let desc = meta.description || '';
        if (meta.description_file) {
          try {
            const d = await fetch(meta.description_file);
            if (d.ok) desc = await d.text();
          } catch(_) {}
        }

        // UI text
        els.challengeTitle.textContent = meta.title || '';
        els.question.textContent = desc || 'No description provided.';

        // Put starter SQL in editor
        setSQL(APP.starterSQL);

        // Show schema
        renderSchema();

        // Quick preview of first table (if any)
        const tnames = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name");
        if (tnames.length && tnames[0].values.length) {
          const firstTable = tnames[0].values[0][0];
          const res = db.exec(`SELECT * FROM ${firstTable} LIMIT 5`);
          if (res.length) renderTable(res[0]);
        } else {
          els.results.innerHTML = '<span class="muted">Seed loaded (no tables).</span>';
        }
      } catch (e) {
        els.status.textContent = 'Load error: ' + e.message;
        els.status.className = 'warn';
      } finally {
        setReady(true);
      }
    }

    function runQuery() {
      if (!db) { els.results.innerHTML = '<span class="warn">DB not ready.</span>'; return; }
      const sql = getSQL().trim();
      els.runInfo.textContent = 'Running…';
      const t0 = performance.now();
      try {
        const results = db.exec(sql);
        const ms = Math.max(1, Math.round(performance.now() - t0));
        if (!results.length) {
          els.results.innerHTML = '<span class="muted">Query OK (no rows)</span>';
          els.runInfo.textContent = `Time: ${ms} ms`;
        } else {
          renderTable(results[0]);
          const rows = results[0].values.length;
          els.runInfo.textContent = `Rows: ${rows} • Time: ${ms} ms`;
        }
      } catch (e) {
        els.results.innerHTML = '<span class="warn">' + e.message + '</span>';
        els.runInfo.textContent = '';
      }
    }

    function resetDB() {
      if (!APP.seedSQL) return;
      db = new SQL.Database();
      db.run(APP.seedSQL);
      els.runInfo.textContent = 'DB reset';
      renderSchema();
      const tnames = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name");
      if (tnames.length && tnames[0].values.length) {
        const firstTable = tnames[0].values[0][0];
        const res = db.exec(`SELECT * FROM ${firstTable} LIMIT 5`);
        if (res.length) renderTable(res[0]);
      } else {
        els.results.innerHTML = '<span class="muted">Seed loaded (no tables).</span>';
      }
    }

    function toTableHTML(res) {
      if (!res || !res.length || !res[0].columns) return '<div class="muted">No rows.</div>';
      return tableHTML(res[0]);
    }

    function grade() {
      if (!db) { els.gradeStatus.textContent = 'DB not ready.'; els.gradeStatus.className='warn'; return; }
      const userSQL = getSQL().trim();
      els.gradeStatus.textContent = ''; els.gradeDiff.innerHTML = '';
      if (!/^select/i.test(userSQL)) {
        els.gradeStatus.textContent = 'Only SELECT queries can be submitted.';
        els.gradeStatus.className = 'warn';
        return;
      }
      try {
        db.run('DROP TABLE IF EXISTS __user__;');
        db.run('DROP TABLE IF EXISTS __truth__;');
        db.run(`CREATE TEMP TABLE __user__ AS ${userSQL}`);
        db.run(`CREATE TEMP TABLE __truth__ AS ${APP.solutionSQL}`);

        // Column sanity
        if (APP.expectColumns && APP.expectColumns.length) {
          const info = db.exec("PRAGMA table_info(__user__)");
          if (!info.length) { els.gradeStatus.textContent='Your query returned no table.'; els.gradeStatus.className='warn'; return; }
          const cols = info[0].values.map(r => String(r[1]).toLowerCase());
          const missing = APP.expectColumns.filter(c => !cols.includes(c.toLowerCase()));
          if (missing.length) { els.gradeStatus.textContent = '❌ Missing column(s): ' + missing.join(', '); els.gradeStatus.className='warn'; return; }
        }

        const miss = db.exec("SELECT * FROM __truth__ EXCEPT SELECT * FROM __user__");
        const extra = db.exec("SELECT * FROM __user__  EXCEPT SELECT * FROM __truth__");
        const hasMiss = miss.length && miss[0].values.length;
        const hasExtra = extra.length && extra[0].values.length;

        if (!hasMiss && !hasExtra) { els.gradeStatus.textContent = '✅ Correct!'; els.gradeStatus.className='ok'; }
        else {
          els.gradeStatus.textContent = '❌ Not quite — see differences below.'; els.gradeStatus.className='warn';
          let out = '';
          if (hasMiss) out += '<div class="muted">Missing rows (truth − yours):</div>' + toTableHTML(miss);
          if (hasExtra) out += '<div class="muted">Extra rows (yours − truth):</div>' + toTableHTML(extra);
          els.gradeDiff.innerHTML = out;
        }
      } catch (e) {
        els.gradeStatus.textContent = 'Error grading: ' + e.message;
        els.gradeStatus.className = 'warn';
      }
    }

    // Events
    document.getElementById('run').addEventListener('click', runQuery);
    document.getElementById('reset').addEventListener('click', resetDB);
    document.getElementById('check').addEventListener('click', grade);
    document.addEventListener('keydown', (e) => {
      if (cm) {
        // CodeMirror handles keymaps we added; no-op here
      } else if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        runQuery(); // textarea fallback
      }
    });

    // Start
    boot();
  </script>
</body>
</html>
